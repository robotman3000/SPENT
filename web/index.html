<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="user-scalable=no, width=device-width, initial-scale=1.0, maximum-scale=1.0"/>
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="white" />
	<meta content="the SimPle ExpeNse Tracker" name="description">
	<meta content="robotman3000" name="author">
	<title>SPENT</title>

	<!-- JQuery -->
	<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.js"></script>

	<!-- Support -->
	<link href="/css/glyphicons-fontawesome.css" rel="stylesheet" type="text/css" />
	<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.15.0/umd/popper.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/jquery-extendext@0.1.2/jQuery.extendext.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/dot@1.1.2/doT.js"></script>
	<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.24.0/moment.js"></script><!-- v2.24.0 -->
	<script src="https://cdnjs.cloudflare.com/ajax/libs/caret/1.3.7/jquery.caret.js"></script>
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/tag-editor/1.0.20/jquery.tag-editor.css" />
	<script src="https://cdnjs.cloudflare.com/ajax/libs/tag-editor/1.0.20/jquery.tag-editor.js"></script>

	<!-- Bootstrap v4 -->
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.3.1/css/bootstrap.css"><!-- v4.3.1 -->
	<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.3.1/js/bootstrap.bundle.js"></script><!-- v4.3.1 -->

	<!-- Bootstrap-Treeview -->
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/patternfly-bootstrap-treeview@2.1.10/dist/bootstrap-treeview.css">
	<script src="https://cdn.jsdelivr.net/npm/patternfly-bootstrap-treeview@2.1.10/dist/bootstrap-treeview.js"></script>

	<!-- JS-Grid -->
    <link type="text/css" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jsgrid/1.5.3/jsgrid.css" />
    <link type="text/css" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jsgrid/1.5.3/jsgrid-theme.css" />
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jsgrid/1.5.3/jsgrid.js"></script>

	<!-- jQuery-QueryBuilder -->
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/jQuery-QueryBuilder@2.5.2/dist/css/query-builder.default.css">
	<script src="https://cdn.jsdelivr.net/npm/jQuery-QueryBuilder@2.5.2/dist/js/query-builder.min.js"></script>

	<!-- SPENT -->
	<link href="/css/SPENT.css" rel="stylesheet">
	<script type="text/javascript" src="/js/SPENT.js"></script>
</head>
<body>		
	<div class="container-fluid p-0">
		<div class="row no-gutters">
			<div class="col">
				<nav class="navbar bg-light navbar-light fixed-top" style="height: 56px">
					<a class="navbar-brand" href="#">SPENT</a>
					
					<!-- Toggler/collapsibe Button -->
					<!--button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#collapsibleNavbar">
						<span class="navbar-toggler-icon"></span>
					</button>
					<div class="collapse navbar-collapse" id="collapsibleNavbar"-->
						<ul class="nav nav-pills">
							<li class="nav-item">
								<a class="nav-link active" data-toggle="pill" href="#transactionTableTab">Trans</a>
							</li>
						</ul>

						<ul class="nav nav-pills">
							<li class="nav-item dropdown">
								<a class="nav-link dropdown-toggle" data-toggle="dropdown" href="#" role="button" aria-haspopup="true" aria-expanded="false"><i class="fas fa-bars"></i></a>
								<div class="dropdown-menu dropdown-menu-right">
									<button id="accountTableModalToggle" class="dropdown-item">Edit Accounts</button>
									<button id="bucketTableModalToggle" class="dropdown-item">Edit Buckets</button>
									<button id="tagManagerModalToggle" class="dropdown-item">Manage Tags</button>
									<!--div class="dropdown-divider"></div>
									<button id="something" class="dropdown-item">Seperated Link</button-->
								</div>
							</li>

						</ul>
					
					<!--/div-->
				</nav> 
			</div>
		</div>
		<div class="row no-gutters" style="margin-top: 56px; overflow-x: hidden;">
			<div class="col tab-content">
				<div class="tab-pane container-fluid active" id="transactionTableTab">
					<div class="row">
						<div class="col-md-4 col-lg-3">
							<div class="row bg-light">
								<p id="balanceDisplay" style="float: right; margin: auto;">Waiting on server for account balance...</p>
							</div>
							<div class="row">
								<!-- TODO: The way we are using the width property is nasty, find a better way -->
								<div id="accountTree" style="width: 1000em"></div>
							</div>
						</div>
						<div class="col-md-8 col-lg-9 p-0">
							<!-- Transaction Table -->
							<table id="transactionTable" class="table-striped table-hover table-responsive"></table>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>

	<!-- Tag Manager Modal -->
	<div class="modal fade" id="tagManagerModal" tabindex="-1" role="dialog" aria-labelledby="transactionTableFilterModal-label" aria-hidden="true">
		<div class="modal-dialog modal-dialog-scrollable modal-dialog-centered" role="document">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title" id="tagManagerModal-label">Tag Manager</h5>
					<button type="button" class="close" data-dismiss="modal" aria-label="Close">
					<span aria-hidden="true">&times;</span>
					</button>
				</div>
				<div class="modal-body">

				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-danger" data-dismiss="modal">Close</button>
				</div>
			</div>
		</div>
	</div>

	<!-- Transaction Tag Editor Modal -->
	<div class="modal fade" id="transactionTagEditFormModal" tabindex="-1" role="dialog" aria-labelledby="transactionTableFilterModal-label" aria-hidden="true">
		<div class="modal-dialog modal-dialog-scrollable modal-dialog-centered" role="document">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title" id="transactionTagEditorModal-label">Transaction Tags</h5>
					<button type="button" class="close" data-dismiss="modal" aria-label="Close">
					<span aria-hidden="true">&times;</span>
					</button>
				</div>
				<div class="modal-body">

					<div id="transactionTagEditFormDiv" data-submit="true"></div>

				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-danger" data-dismiss="modal">Close</button>
				</div>
			</div>
		</div>
	</div>

	<!-- Transaction Table Filter Modal -->
	<div class="modal fade" id="transactionTableFilterModal" tabindex="-1" role="dialog" aria-labelledby="transactionTableFilterModal-label" aria-hidden="true">
		<div class="modal-dialog modal-dialog-scrollable modal-dialog-centered" role="document">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title" id="transactionTableFilterModal-label">Transaction Filters</h5>
					<button type="button" class="close" data-dismiss="modal" aria-label="Close">
					<span aria-hidden="true">&times;</span>
					</button>
				</div>
				<div class="modal-body">

					<div id="transactionTableFilter"></div>

				</div>
				<div class="modal-footer">
					<button type="button" class="btn" id="btn-get">Get Rules</button>
					<button type="button" class="btn btn-danger" data-dismiss="modal">Close</button>
				</div>
			</div>
		</div>
	</div>

	<!-- Account Table Modal -->
	<div class="modal fade" id="accountTableModal" tabindex="-1" role="dialog" aria-labelledby="accountTableModal-label" aria-hidden="true">
		<div class="modal-dialog modal-dialog-scrollable modal-dialog-centered" role="document">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title" id="accountTableModal-label">Accounts</h5>
					<button type="button" class="close" data-dismiss="modal" aria-label="Close">
						<span aria-hidden="true">&times;</span>
					</button>
					<div id="accountTableEditToolbar"></div>
				</div>
				<div class="modal-body">

					<table id="accountTable" class="table-striped table-hover" data-editing-always-show="true" data-paging="false" data-filtering="false" data-sorting="true" data-editing="true" data-state="false"></table>

				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-danger" data-dismiss="modal">Close</button>
				</div>
			</div>
		</div>
	</div>

	<!-- Bucket Table Modal -->
	<div class="modal fade" id="bucketTableModal" tabindex="-1" role="dialog" aria-labelledby="bucketTableModal-label" aria-hidden="true">
		<div class="modal-dialog modal-dialog-scrollable modal-dialog-centered" role="document">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title" id="bucketTableModal-label">Buckets</h5>
					<button type="button" class="close" data-dismiss="modal" aria-label="Close">
					<span aria-hidden="true">&times;</span>
					</button>
				</div>
				<div class="modal-body">
					<div id="bucketTableEditToolbar"><select id="bucketEditAccountSelect"></select></div>
					<table id="bucketTable" class="table-striped table-hover" data-editing-always-show="true" data-paging="false" data-filtering="false" data-sorting="true" data-editing="true" data-state="false"></table>

				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-danger" data-dismiss="modal">Close</button>
				</div>
			</div>
		</div>
	</div>

	<!-- Transaction Edit Form Modal -->
	<div class="modal fade" id="transactionTableEditFormModal" tabindex="-1" role="dialog" aria-labelledby="transactionTableEditFormModal-label" aria-hidden="true">
		<div class="modal-dialog modal-dialog-scrollable modal-dialog-centered" role="document">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title" id="transactionTableEditFormModal-label">{Modal Heading}</h5>
					<button type="button" class="close" data-dismiss="modal" aria-label="Close">
					<span aria-hidden="true">&times;</span>
					</button>
				</div>
				<div class="modal-body">

					<div id="transactionTableEditFormDiv" data-submit="true"></div>

				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-danger" data-dismiss="modal">Close</button>
				</div>
			</div>
		</div>
	</div>

	<!-- Account Edit Form Modal -->
	<div class="modal fade" id="accountTableEditFormModal" tabindex="-1" role="dialog" aria-labelledby="accountTableEditFormModal-label" aria-hidden="true">
		<div class="modal-dialog modal-dialog-scrollable modal-dialog-centered" role="document">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title" id="accountTableEditFormModal-label">{Modal Heading}</h5>
					<button type="button" class="close" data-dismiss="modal" aria-label="Close">
					<span aria-hidden="true">&times;</span>
					</button>
				</div>
				<div class="modal-body">

					<div id="accountTableEditFormDiv" data-submit="true"></div>

				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-danger" data-dismiss="modal">Close</button>
				</div>
			</div>
		</div>
	</div>

	<!-- Bucket Edit Form Modal -->
	<div class="modal fade" id="bucketTableEditFormModal" tabindex="-1" role="dialog" aria-labelledby="bucketTableEditFormModal-label" aria-hidden="true">
		<div class="modal-dialog modal-dialog-scrollable modal-dialog-centered" role="document">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title" id="bucketTableEditFormModal-label">{Modal Heading}</h5>
					<button type="button" class="close" data-dismiss="modal" aria-label="Close">
					<span aria-hidden="true">&times;</span>
					</button>
				</div>
				<div class="modal-body">

					<div id="bucketTableEditFormDiv" data-submit="true"></div>

				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-danger" data-dismiss="modal">Close</button>
				</div>
			</div>
		</div>
	</div>

	<!-- Action Confirmation Modal -->
	<div class="modal fade" id="confirmActionModal" tabindex="-1" role="dialog" aria-labelledby="confirmActionModal-label" aria-hidden="true">
		<div class="modal-dialog modal-dialog-scrollable modal-dialog-centered" role="document">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title" id="confirmActionModal-label">Confirm</h5>
					<button type="button" class="close" data-dismiss="modal" aria-label="Close">
					<span aria-hidden="true">&times;</span>
					</button>
				</div>
				<div class="modal-body">

					<p id="confirmActionModalText"></p>

				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-primary" id="confirmActionModal-False" onclick="_confirmHandler_(false)">No</button>
					<button type="button" class="btn btn-secondary" id="confirmActionModal-True" onclick="_confirmHandler_(true)">Yes</button>
				</div>
			</div>
		</div>
	</div>


	<script src="https://kit.fontawesome.com/5762666c4b.js" crossorigin="anonymous"></script>
	<script>
		function registerModal(name){
			// Get the modal
			var modal = document.getElementById(name);

			// Get the button that opens the modal
			var btn = document.getElementById(name + "Toggle");

			// Get the <span> element that closes the modal
			//var span = document.getElementById(name + "Close");

			if(btn){
				// When the user clicks on the button, open the modal
				btn.onclick = function() {
					showModal(name);
				}
			}

			/*if(span){
				// When the user clicks on <span> (x), close the modal
				span.onclick = function() {
					hideModal(name);
				}
			}*/

			// When the user clicks anywhere outside of the modal, close it
			/*window.onclick = function(event) {
				if (event.target == modal) {
					if(modal){
						modal.style.display = "none";
					}
				}
			} */	
		}

		function _confirmHandler_(result){
			var callback = $("#confirmActionModal").data("callback")
			$("#confirmActionModal").data("callback", null)
			if(callback){
				callback(result);
			}
			hideModal("confirmActionModal")
		}

		function initConfirmModal(){
			registerModal("confirmActionModal");
		}

		function showConfirmModal(message, callback){
			var modal = $("#confirmActionModal")
			modal.data("callback", callback)

			if (!message){
				message = "Confirm Action"
			}

			$("#confirmActionModalText").text(message)

			showModal("confirmActionModal")
		}

		function showModal(name){
			//var modal = document.getElementById(name);
			//modal.style.display = "block";

			$('#' + name).modal('show');
		}
		
		function hideModal(name){
			//var modal = document.getElementById(name);
			//modal.style.display = "none";

			$('#' + name).modal('hide');
		}
		
		function dateToStr(d){
			var month = '' + (d.getMonth() + 1),
				day = '' + d.getDate(),
				year = d.getFullYear();

			if (month.length < 2) month = '0' + month;
			if (day.length < 2) day = '0' + day;

			return [year, month, day].join('-');

		}
		
		function updateFormContent(name, data, title){
			var form = $("#" + name);

			if (title == undefined){
				title = "No Title";
			}
			$("#" + name + "Modal-label").text(title)

			// Input Elements
			var inputs = form.find("input").toArray();
			inputs.forEach(function(item, index){
				if (!(item.type == "submit")){
					var key = item.name;
					var oldValue = getOrDefault(data, key, "");
					if(oldValue.toDate){
						var d = new Date(1971,01,01);
						if(oldValue.toDate() < d){
							return "";
						}
						oldValue = dateToStr(oldValue.toDate());
					}
					$(item).val(oldValue);
				}
			});
			
			//Select Elements
			var inputs = form.find("select").toArray();
			inputs.forEach(function(item, index){
				var key = item.name;
				var oldValue = getOrDefault(data, key, null);
				if(oldValue == null){
					item.selectedIndex = 0;
				} else {
					$(item).val(oldValue);
				}
			});
			
			
			//TODO: This should not return the form
			// It is just a quick fix
			return form;
		}

		$(document).ready(function() {
			registerModal("bucketTableModal");
			registerModal("accountTableModal");
			
			registerModal("transactionTableEditFormModal");
			registerModal("bucketTableEditFormModal");
			registerModal("accountTableEditFormModal");
			registerModal("transactionTagEditFormModal");

			registerModal("transactionTableFilterModal");
			registerModal("tagManagerModal");

			initConfirmModal();

			onDocumentReady();
		});
	</script>
</body>